// Load Template Modules

$('.E2Module').each(function() {
    var elem = $(this);
    $.ajax({
        url : chrome.extension.getURL("Module/" + $(this).attr('template') + ".html") + "?t=" + new Date().getTime(),
        async : false,
        dataType : 'html',
        success : function(data) {
            elem.replaceWith(data);
        }
    });
});

var SEModuleHelper = {
        convertWeekDate : function(dDate){
            var now = new Date();
            //var local = new Date(dDate.toLocaleString());
            //if(!isNaN(local)){
            if (dDate instanceof Date) {
                var local = dDate;
                var resultDate;

                var minutes = (local.getMinutes() < 10)? '0'+local.getMinutes() : local.getMinutes();
                var hours = local.getHours();
                var ampm;

                var date = (local.getDate() < 10)? '0'+local.getDate() : local.getDate();
                var month = local.getMonth();
                var day = local.getDay();
                // month = (month < 10)? '0'+month : month
                var weekArray = Locale.Date.WEEK;
                for(var i = 0; i < weekArray.length; i++) {
                    weekArray[i] = weekArray[i].toUpperCase();
                }

                if (hours == 0) {
                    hours = '12';
                    ampm = Locale.Date.AM;
                } else if (hours < 12) {
                    ampm = Locale.Date.AM;
                } else if (hours == 12) {
                    ampm = Locale.Date.PM;
                } else {
                    hours -= 12;
                    ampm = Locale.Date.PM;
                }

                resultDate = weekArray[day]+" "+hours+":"+minutes+ampm;

                return resultDate;
            }
        },
        convertShortDate : function(dDate){
            var now = new Date();
            //var local = new Date(dDate.toLocaleString());
            //if(!isNaN(local)){
            if (dDate instanceof Date) {
                var local = dDate;
                var resultDate;

                var minutes = (local.getMinutes() < 10)? '0'+local.getMinutes() : local.getMinutes();
                var hours = local.getHours();
                var ampm;

                var date = (local.getDate() < 10)? '0'+local.getDate() : local.getDate();
                var month = local.getMonth();
                // month = (month < 10)? '0'+month : month

                var monthArray = Locale.Date.MONTH;
                for(var i = 0; i < monthArray.length; i++) {
                    monthArray[i] = monthArray[i].toUpperCase();
                }

                if (hours == 0) {
                    hours = '12';
                    ampm = Locale.Date.AM;
                } else if (hours < 12) {
                    ampm = Locale.Date.AM;
                } else if (hours == 12) {
                    ampm = Locale.Date.PM;
                } else {
                    hours -= 12;
                    ampm = Locale.Date.PM;
                }

                if(now.getFullYear() == local.getFullYear() && now.getDate() == local.getDate() && now.getMonth() == local.getMonth()){
                    //resultDate = "TODAY "+hours+":"+minutes+ampm;
                    resultDate = hours+":"+minutes+ampm;
                }else if(now.getFullYear() == local.getFullYear()){
                    resultDate = monthArray[month]+' ' + date+", "+hours+":"+minutes+ampm;
                }else{
                    var date = (local.getDate() < 10)? '0'+local.getDate() : local.getDate();
                    resultDate = monthArray[month]+' ' + date+' ' + local.getFullYear();
                }

                return resultDate;
            }
        },
        convertDate : function(dDate) {
            var now = new Date();
            //var local = new Date(dDate.toLocaleString());
            //if (!isNaN(local)) {
            if (dDate instanceof Date) {
                var local = dDate;
                var resultDate;

                var minutes = (local.getMinutes() < 10) ? '0' + local.getMinutes() : local.getMinutes();
                var hours = local.getHours();
                var ampm;

                var date = (local.getDate() < 10) ? '0' + local.getDate() : local.getDate();
                var month = local.getMonth();
                // month = (month < 10)? '0'+month : month
                var monthArray = Locale.Date.MONTH;

                if (hours == 0) {
                    hours = '12';
                    ampm = Locale.Date.AM;
                } else if (hours < 12) {
                    ampm = Locale.Date.AM;
                } else if (hours == 12) {
                    ampm = Locale.Date.PM;
                } else {
                    hours -= 12;
                    ampm = Locale.Date.PM;
                }

                if (now.getFullYear() == local.getFullYear() && now.getDate() == local.getDate() && now.getMonth() == local.getMonth()) {

                    resultDate = Locale.Date.TODAY + " " + hours + ":" + minutes + ampm;
                } else if (now.getFullYear() == local.getFullYear()) {
                    resultDate = monthArray[month] + ' ' + date + ", " + hours + ":" + minutes + ampm;
                } else {
                    var date = (local.getDate() < 10) ? '0' + local.getDate() : local.getDate();
                    resultDate = monthArray[month] + ' ' + date + ' ' + local.getFullYear();
                }

                return resultDate;
            }
        }
};


var Portal = {
    mode: 'webapp',
    type: 'chrome',
    init : function() {
        window.params = function() {
            var params = {};
            var p = window.location.href.split('?');
            if(p.length > 1) {
                var param_array = window.location.href.split('?')[1].split('&');
                for (var i in param_array) {
                    x = param_array[i].split('=');
                    params[x[0]] = x[1];
                }
            }
            return params;
        }();
        var msg = (window.params.mg) ? window.params.mg : false;
        var pencode = (window.params.pencode) ? window.params.pencode : false;
        var version = (window.params.version) ? window.params.version : Application.version;
        var action = (window.params.action) ? window.params.action : false;
        var preview = (window.params.preview) ? window.params.preview : false;
        var email = (window.params.e) ? window.params.e : false;
        Application.setPreferences({
            messageId : msg,
            sourcePenCode: pencode,
            version: version,
            action: action,
            preview: preview,
        });
        if(email) {
            Application.setPreferences({
                email: email
            });
        }
    },

    sendAuth: function() {
        if(window.parent && window.parent.postMessage) {
            window.parent.postMessage({
            type: 'setPreference',
            item: 'complete'
            }, '*');
        }
    },

    close: function() {
        if(window.parent && window.parent.postMessage) {
            window.parent.postMessage({
            type: 'closeApp'
            }, '*');
        }
    },

    getVersion: function(){
        return Application.getPreferences().version;
    },

    logout : function() {
        /*
         if (window.parent && window.parent.forceLogout) {
         window.parent.forceLogout();
         }
         */
    },
    removeAuthentication : function() {
        /*
         if (window.parent && window.parent.removeAuthentication) {
         window.parent.removeAuthentication();
         }
         */
    }
};


if (typeof module !== 'undefined' && module.exports) {
    module.exports = Portal;
} else {
    window.Portal = Portal;
}

$(document).ready(function() {

    $('body').on('click', '.reloadIframe', function(){
       location.reload(); 
    });
    
    setTimeout(function() {
        //console && console.log('index loaded');
        Portal.init();
        Application.initialize();
    }, 500);

});
